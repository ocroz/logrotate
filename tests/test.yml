---

- name: Test Logrotate role
  hosts: all

  pre_tasks:
    - name: Update apt
      become: yes
      apt:
        cache_valid_time: 1800
        update_cache: yes
      tags:
        - build

  roles:
    - role: sansible.logrotate
      logrotate:
        builtin_configs:
          application_logs:
            enabled: true
            paths:
              - "/var/log/dummy.log"
        custom_configs:
          - name: nginx
            path: "/var/log/nginx/*.log"
            options:
              - daily
              - missingok
              - rotate 7
              - compress
              - delaycompress
              - notifempty
              - "create 0640 www-data adm"
              - sharedscripts
            scripts:
              postrotate: "[ -s /run/nginx.pid ] && kill -USR1 $( cat /run/nginx.pid )"
              prerotate: "if [ -d /etc/logrotate.d/httpd-prerotate ]; then run-parts /etc/logrotate.d/httpd-prerotate; fi"

  post_tasks:
    - name: Logrotate should be installed
      command: logrotate --version
      tags:
        - assert
